"""
üöÄ TERMUX TELEGRAM BOT - Modular Architecture  
üì± Bot khusus untuk Android Termux dengan arsitektur modular
üéØ Clean code structure untuk maintainability yang lebih baik
"""

import os
import sys
import logging
from pathlib import Path

# Setup logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

try:
    TELEGRAM_AVAILABLE = True
    logger.info("‚úÖ Telegram library available")
except ImportError:
    TELEGRAM_AVAILABLE = False
    logger.error("‚ùå Telegram library not available")
    print("üì¶ Install: pip install python-telegram-bot")

# Import the new modular bot orchestrator
from .bot_orchestrator import create_bot

# Project paths untuk Termux
PROJECT_ROOT = Path(__file__).parent.parent.parent
TERMUX_HOME = Path("/data/data/com.termux/files/home")
STORAGE_PATH = TERMUX_HOME / "storage" / "shared"


class TermuxTelegramBot:
    """ü§ñ Termux Telegram Bot with modular architecture"""
    
    def __init__(self):
        self.bot = None
        self.token = None
        self.is_setup_mode = False
        
        logger.info("ü§ñ Termux Telegram Bot initialized with modular structure")
    
    async def auto_start(self):
        """üöÄ Auto start dengan deteksi setup untuk Termux"""
        logger.info("üì± Starting modular Termux bot...")
        
        env_file = PROJECT_ROOT / ".env"
        
        if not env_file.exists() or not self._is_setup_complete():
            logger.info("üõ†Ô∏è Setup required...")
            await self._run_termux_setup()
        else:
            logger.info("‚úÖ Setup complete, starting modular bot...")
            await self._run_termux_bot()
    
    def _is_setup_complete(self) -> bool:
        """‚úÖ Check setup status"""
        try:
            env_file = PROJECT_ROOT / ".env"
            if not env_file.exists():
                return False
            
            with open(env_file, 'r') as f:
                content = f.read()
            
            has_token = 'TELEGRAM_BOT_TOKEN=' in content and 'your_bot_token' not in content.lower()
            has_user_id = 'ALLOWED_USER_IDS=' in content and 'your_user_id' not in content.lower()
            
            return has_token and has_user_id
        except:
            return False
    
    async def _run_termux_setup(self):
        """üõ†Ô∏è Interactive setup untuk Termux"""
        print("\n" + "="*50)
        print("ü§ñ TERMUX BACKUP SYSTEM - MODULAR SETUP")
        print("üì± Setup khusus untuk Android Termux")
        print("üéØ Menggunakan arsitektur modular yang baru")
        print("="*50)
        
        # Step 1: Bot Token
        print("\nüìã STEP 1: Telegram Bot Setup")
        print("1. Buka Telegram, cari @BotFather")
        print("2. Kirim: /newbot")
        print("3. Ikuti instruksi buat bot")
        print("4. Copy token yang diberikan")
        
        while True:
            token = input("\nüîë Paste Bot Token: ").strip()
            if token and len(token) > 40:
                self.token = token
                break
            print("‚ùå Token tidak valid. Coba lagi.")
        
        # Step 2: User ID
        print("\nüìã STEP 2: User ID Setup")
        print("1. Buka Telegram, cari @userinfobot")
        print("2. Kirim: /start")
        print("3. Copy ID yang diberikan")
        
        while True:
            user_id = input("\nüë§ Paste User ID: ").strip()
            if user_id.isdigit() and len(user_id) > 5:
                break
            print("‚ùå User ID tidak valid. Coba lagi.")
        
        # Step 3: Save configuration
        await self._save_config(self.token, user_id)
        
        print("\n‚úÖ Setup selesai!")
        print("üöÄ Starting modular bot...")
        await self._run_termux_bot()
    
    async def _save_config(self, token: str, user_id: str):
        """üíæ Save configuration to .env file"""
        env_content = f"""# TERMUX TELEGRAM BOT - MODULAR CONFIG
# Configuration for Android Termux environment
# Auto-generated by modular setup

# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN={token}
ALLOWED_USER_IDS={user_id}

# Termux Paths
TERMUX_HOME=/data/data/com.termux/files/home
STORAGE_PATH=/data/data/com.termux/files/home/storage/shared

# Feature Flags (Modular Architecture)
ENABLE_GOOGLE_DRIVE=true
ENABLE_AUTO_DELETE=false
ENABLE_NOTIFICATIONS=true
ENABLE_DEBUG=false

# Performance Settings
MAX_CONCURRENT_UPLOADS=3
CHUNK_SIZE_MB=8
RETRY_ATTEMPTS=3
TIMEOUT_SECONDS=30

# Security Settings
ENCRYPTION_ENABLED=true
AUTO_LOCK_HOURS=1
AUDIT_LOGGING=true
"""
        
        env_file = PROJECT_ROOT / ".env"
        with open(env_file, 'w', encoding='utf-8') as f:
            f.write(env_content)
        
        logger.info("Configuration saved with modular settings")
    
    async def _run_termux_bot(self):
        """üöÄ Run the modular bot"""
        try:
            # Load token from environment
            if not self.token:
                env_file = PROJECT_ROOT / ".env"
                with open(env_file, 'r') as f:
                    for line in f:
                        if line.startswith('TELEGRAM_BOT_TOKEN='):
                            self.token = line.split('=', 1)[1].strip()
                            break
            
            if not self.token:
                raise ValueError("No bot token found")
            
            # Create modular bot using orchestrator
            logger.info("üéØ Creating modular bot with orchestrator...")
            self.bot = create_bot(self.token)
            
            # Run the bot
            logger.info("üöÄ Starting modular Termux Telegram Bot...")
            logger.info("üì± All handlers loaded from modular structure")
            logger.info("‚úÖ Ready for Android backup operations!")
            
            self.bot.run()
            
        except Exception as e:
            logger.error(f"‚ùå Error starting modular bot: {e}")
            print(f"\n‚ùå Error: {e}")
            print("üîß Check your configuration and try again")
    
    def run_sync(self):
        """üîÑ Synchronous run method"""
        import asyncio
        asyncio.run(self.auto_start())


def main():
    """üéØ Main entry point for Termux environment"""
    logger.info("üöÄ Starting Termux Telegram Bot with modular architecture...")
    
    # Check if running in Termux
    is_termux = os.path.exists("/data/data/com.termux")
    if is_termux:
        logger.info("üì± Termux environment detected")
    else:
        logger.info("üíª Non-Termux environment detected")
    
    # Create and run bot
    bot = TermuxTelegramBot()
    bot.run_sync()


if __name__ == "__main__":
    main()
